# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

EMS-SEP490-BE is a Spring Boot backend for an Education Management System (EMS) designed for language training centers. The system manages multi-tenant operations (centers → branches) including course curriculum, class scheduling, teacher assignments, student enrollments, attendance tracking, and request workflows.

**Tech Stack:**
- Spring Boot 3.5.6
- Java 21
- PostgreSQL (with custom enum types)
- Spring Data JPA (Hibernate)
- Spring Security
- Lombok
- Maven

## Development Commands

### Building & Running
```bash
# Build the project
./mvnw clean install

# Run the application (will start on default port 8080)
./mvnw spring-boot:run

# Run tests
./mvnw test

# Run a specific test class
./mvnw test -Dtest=ClassName

# Run a specific test method
./mvnw test -Dtest=ClassName#methodName

# Package without running tests
./mvnw clean package -DskipTests
```

### Database Setup
- PostgreSQL database required: `ems` on `localhost:5432`
- Default credentials in `application.yml` (username: postgres, password: 979712)
- Schema initialization: `schema.sql` creates enum types on first run
- Hibernate DDL mode: `update` (auto-creates/updates tables from entities)

**IMPORTANT:** The `schema.sql` file ONLY defines PostgreSQL enum types. Tables are auto-generated by Hibernate from entity classes.

## Architecture & Design Patterns

### Session-First Design Pattern
The core architectural principle is that **session is the source of truth** for all schedule-related operations. This pattern affects:

1. **Class Creation Flow:**
   - Academic Staff creates a `ClassEntity` (draft status)
   - System auto-generates `SessionEntity` records from course template (`Course → CoursePhase → CourseSession`)
   - Sessions are created based on `start_date`, `schedule_days[]`, and `time_slot_template`

2. **Student Enrollment Flow:**
   - When a student enrolls in a class, system auto-generates `StudentSession` records
   - Each `StudentSession` maps to a `SessionEntity` and tracks individual attendance
   - Schedule changes at session level automatically propagate to all enrolled students

3. **Request Processing:**
   - All schedule modifications (reschedule, cancellation, make-up) operate on `SessionEntity`
   - Changes to sessions trigger updates to related `StudentSession`, `TeachingSlot`, and `SessionResource` records
   - This ensures referential integrity and complete audit trail

### Domain Model Organization

**Core Entities (42 total):**

1. **Organization & Infrastructure:**
   - `Center`, `Branch` (multi-tenant structure)
   - `Resource` (unified model for ROOM and VIRTUAL/Zoom)
   - `TimeSlotTemplate` (defines allowed class times per branch)

2. **Academic Curriculum:**
   - `Subject → Level → Course → CoursePhase → CourseSession` (template hierarchy)
   - `Plo` (Program Learning Outcomes), `Clo` (Course Learning Outcomes)
   - `PloCloMapping`, `CourseSessionCloMapping` (outcome tracking)
   - `CourseMaterial` (linked to Course/Phase/Session)

3. **People:**
   - `UserAccount → UserRole → Role` (RBAC system)
   - `UserBranch` (multi-branch access control)
   - `Student`, `Teacher` (1-1 mapping with UserAccount)
   - `TeacherSkill`, `TeacherAvailability`, `TeacherAvailabilityOverride`

4. **Operations:**
   - `ClassEntity` (instance of a Course at a Branch)
   - `SessionEntity` (actual class meeting, auto-generated from CourseSession template)
   - `SessionResource` (room/zoom assignment)
   - `TeachingSlot` (teacher assignment to session with skill and role)
   - `Enrollment` (student registration in class)
   - `StudentSession` (student's individual session record with attendance)

5. **Assessment & Feedback:**
   - `Assessment`, `Score`
   - `StudentFeedback`, `QaReport`

6. **Request Workflows:**
   - `StudentRequest` (absence, makeup, transfer, reschedule)
   - `TeacherRequest` (leave, swap, ot, reschedule)

### Enum Management

PostgreSQL enums are defined in `schema.sql` and must be created BEFORE Hibernate runs. Entity classes use `@Enumerated(EnumType.STRING)` to map to these database enums.

**Pattern for adding new enums:**
1. Add `CREATE TYPE` statement to `schema.sql` (e.g., `CREATE TYPE status_enum AS ENUM ('active','inactive');`)
2. Create corresponding Java enum in `entities/enums/`
3. Use `@Enumerated(EnumType.STRING)` in entity field
4. For array types (e.g., `skill_enum[]`), also add `@JdbcTypeCode(SqlTypes.ARRAY)`

### Exception Handling

Centralized exception handling via `GlobalExceptionHandler` (@ControllerAdvice):
- All API responses follow `ResponseObject<T>` pattern (status, message, data)
- Custom exceptions extend `CustomException` with `ErrorCode`
- Standard exceptions (validation, not found, illegal argument) are handled uniformly

### Package Structure

```
org.fyp.emssep490be/
├── configs/           (Spring configurations - currently empty)
├── controllers/       (REST endpoints - currently empty, to be implemented)
├── dtos/              (Data Transfer Objects including ResponseObject)
├── entities/          (JPA entities - 42 domain models)
│   └── enums/         (16 enum types matching PostgreSQL enums)
├── exceptions/        (CustomException, ErrorCode, GlobalExceptionHandler)
├── repositories/      (Spring Data JPA repositories - to be implemented)
├── services/          (Business logic layer - to be implemented)
└── utils/             (Helper utilities - to be implemented)
```

## Key Business Rules & Workflows

### 1. Course Approval Workflow
- Subject Leader creates Course → Manager approves (`approved_by_manager`, `approved_at`)
- Only approved courses can be used to create classes
- Rejection requires `rejection_reason`

### 2. Class Creation & Session Generation
- Class starts in `draft` status
- System auto-generates sessions from course template based on:
  - `Course.session_per_week` × `Course.duration_weeks`
  - `ClassEntity.schedule_days[]` (which days of week)
  - `ClassEntity.start_date` + week offset calculation
- Academic Staff assigns teachers/resources, then submits for approval
- Center Head/Manager approves → status becomes `scheduled`

### 3. Enrollment & Synchronization
- Students can only enroll in `scheduled` or `ongoing` classes
- Upon enrollment, system creates `StudentSession` for all planned sessions
- Late enrollment (mid-course): only creates StudentSession for future sessions
- When class schedule changes (reschedule), all StudentSession records sync automatically

### 4. Request Processing (Key Patterns)

**Teacher Leave → Substitution:**
- Teacher submits `TeacherRequest(type='leave')`
- System queries available substitute teachers (skill match + availability + no conflict)
- If substitute found: approve leave → create OT request for substitute → update `TeachingSlot`
- If no substitute: options are reschedule or cancel

**Student Make-up:**
- Student selects missed session → system suggests make-up sessions (same `course_session_id`, different class)
- Upon approval: mark original as `excused`, create new `StudentSession(is_makeup=true)` for make-up session

**Transfer Between Classes:**
- Requires same `course_id` to map remaining sessions by `course_session_id`
- System identifies cutoff point (`left_session_id`, `join_session_id`)
- Updates both enrollments and syncs StudentSession records

### 5. Attendance Locking
- Teachers record attendance via `StudentSession.attendance_status`
- System can lock attendance T hours after session to prevent changes (configured in system settings)

## Important Constraints & Validations

1. **Unique Constraints (enforced by database):**
   - `(center_id, branch_code)` - branch codes unique per center
   - `(subject_id, level_code)` - level codes unique per subject
   - `(branch_id, class_code)` - class codes unique per branch
   - `(phase_id, sequence_no)` - course session sequence unique per phase
   - `(assessment_id, student_id)` - one score per student per assessment
   - Many composite primary keys for junction tables

2. **Business Validations:**
   - Course must be approved before creating class
   - Class must be approved before enrollment
   - Enrollment capacity check (`enrolled < max_capacity`)
   - Resource conflict detection (same resource, overlapping time)
   - Teacher conflict detection (same teacher, overlapping sessions)
   - PLO-CLO mapping validation (must belong to same subject)

3. **Audit Trail Requirements:**
   - Track `created_by`, `created_at` for critical operations
   - Track `approved_by`, `approved_at` for approval workflows
   - Track `decided_by`, `decided_at` for request processing
   - Track `graded_by`, `graded_at` for score entry

## Development Notes

### **Implementation Plan: Core Principles**

**1. Code Quality & Structure:**

- **Clean Implementation:** The implementation must be clean, avoiding unnecessary code, complexity, and "code smells." Adhere strictly to established coding standards and best practices (e.g., SOLID, DRY).
- **No Redundancy (DRY - Don't Repeat Yourself):** Actively prevent code duplication. Abstract and reuse components, functions, and logic wherever possible.
- **Logical Soundness & Correct Algorithms:** Ensure all logic is correct and the algorithms used are efficient and appropriate for the given problem.

**2. System Integrity & Performance:**

- **Prevent Race Conditions:** Proactively identify and prevent potential race conditions to ensure data integrity and system stability, especially in concurrent operations.
- **Avoid Over-engineering:** The solution must not be over-engineered. Implement what is necessary to meet the current requirements without adding speculative features or unnecessary complexity.

**3. Development Approach:**

- **Adhere to Best Practices:** Always follow the best and most current industry-standard approaches for the technologies and patterns being used.
- **Maintain a Holistic View:** Always consider the overall architecture and the impact of your changes on the entire system. Ensure new implementations integrate seamlessly.
- **Focus on the Story & Scope:** Concentrate on delivering the user story at hand. Ensure the implementation directly serves the story's requirements and stays within the defined scope for the MVP (Minimum Viable Product). The primary goal is a functional, demonstrable feature that meets the story's acceptance criteria.

**4. Final Deliverable:**

- **Solid & Maintainable Code:** The final code must be robust, reliable, well-documented, and easy for other developers to understand, modify, and maintain in the future.

### When Adding New Entities:
1. Create enum types in `schema.sql` if needed (with `continue-on-error: true`)
2. Create corresponding Java enum in `entities/enums/`
3. Create entity class with proper relationships (@ManyToOne, @OneToMany)
4. Use Lombok annotations (@Getter, @Setter, @NoArgsConstructor, @AllArgsConstructor)
5. Add unique constraints via `@Table(uniqueConstraints = {...})`
6. Create repository interface extending `JpaRepository`

### When Implementing Controllers:
- Follow RESTful conventions matching the API design in `docs/api-design.md`
- Return `ResponseObject<T>` from all endpoints
- Use `@Valid` for request body validation
- Leverage GlobalExceptionHandler for error handling

### Database Migrations:
- Hibernate `ddl-auto: update` is currently enabled for development
- For production, switch to Flyway/Liquibase for versioned migrations
- Never modify `schema.sql` enum definitions after initial creation (PostgreSQL doesn't support enum modification easily)

### Testing Strategy:
- Unit tests: service layer business logic
- Integration tests: repository layer with @DataJpaTest
- Controller tests: with @WebMvcTest and MockMvc
- End-to-end tests: full workflow scenarios (enrollment → attendance → grading)

## Reference Documentation

- API Design: `docs/api-design.md` (complete RESTful API specification)
- Feature List: `docs/feature-list.md` (detailed business requirements and workflows)
- Spring Boot Guides: `HELP.md`
- Database Schema: PostgreSQL enums in `src/main/resources/schema.sql`

## Project Context

This is a capstone project (SEP490) for a final year project (FYP). The system is designed for real-world deployment at language training centers with multi-branch operations. Focus areas include:
- Robust scheduling with conflict detection
- Automated session generation and synchronization
- Comprehensive request/approval workflows
- Complete audit trail for compliance
- Multi-tenant access control
